---
title: 'Взаимосвязи в компании: отчет'
author: "Деревцова Софья, svderevtsova"
date: '2023-04-07'
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Загрузка данных

```{r message = F}
library(igraphdata)
library(igraph)
data(enron) 
library(lubridate)
source("~/shared/minor2_2022/2-tm-net/hw/personalTask.R")
start_date = hw_net_get_start_date()
# определяем конечную точку месяца
last_date = start_date + dmonths(1)
time = as_date(as_datetime(E(enron)$Time))
# убираем вершины раньше начальной точки и позже конечной
net = enron %>% delete_edges(E(enron)[time < start_date | time > last_date])
# убираем связи вершины самой с собой (согласно данным, иногда люди себя в копию ставят)
net = igraph::simplify(net, remove.multiple = F)
# убираем обособленные вершины
net = net %>% delete_vertices(V(net)[degree(net) == 0])
```


```{r message = F}
LDC = read.csv("~/shared/minor2_2022/2-tm-net/hw/LDC_topics.csv")
```



Анализируются данные с `r start_date` по `r last_date`

## Описание сети

```{r message = F}
summary(net)

mean(degree(net))

diameter(net)

mean_distance(net)
```

Мы имеем сеть, которая описывает структуру взаимодействия между сотрудниками в одной компании, посредством отправленных email. Связь между сотрудниками - отправленное письмо, часто в копии письма стоит несколько человек, поэтому мы имеет связь одного отправителя сразу с несколькими получателями. 

Наша сеть ограничена с помощью даты начала и конца анализа, то есть в моем случае с 01.07.2001 по 01.08.2001, то есть июль 2001 года. 

Для начала мы убираем вершины раньше начальной точки и позже конечной, а затем также убираем связи вершины самой с собой (чтобы не учитывать случаи, люди сами себя в копию ставят) и убираем обособленные вершины. Теперь сделаем summary получившейся сети:
- сеть направленная
- всего 119 вершин, то есть 119 сотрудников
- всего ребер: 3204, то есть количество связей между сотрудниками (переписок)
- средняя степень вершины 53.85 (то есть среднее кол-во полученных писем одним сотрудником)
- диаметр сети равен 10 (максимальное расстояние между двумя вершинами в сети, то есть максимальное количество ребер в кратчайшем пути между любой парой вершин)
- средний кратчайший путь в сети равен 3.87 (то есть среднее значение длин всех кратчайших путей между всеми парами вершин в сети)


### Выявление значимых вершин

**Использованные меры центральности: **

Центральность в сети отражает меру 'важности' вершин в сетевой структуре. Важные вершины могут играть ключевую роль в распространении информации, контроле потока ресурсов, передаче влияния и т.д. 

**Степень вершин: **

Первым показателем центральности, который мы будем рассматривать будет центральность по степени (Degree centrality): отражает количество связей (ребер) у вершины.

```{r message = F}
degree(net)

max(degree(net))
V(net)[degree(net) == max(degree(net))]$Name

min(degree(net))
V(net)[degree(net) == min(degree(net))]$Name

median(degree(net))
```
Теперь рассмотрим параметр degree - степень вершин нашей сети. Степень вершины в сети отражает количество ребер, связанных с данной вершиной. Иными словами, степень вершины показывает, сколько соседей у данной вершины, то есть сколько других вершин она напрямую соединена в сети. Анализ степеней вершин может помочь идентифицировать важные или центральные вершины в сети, такие как хабы, важные узлы в распределении информации или взаимодействии в сети. 

Ранее мы уже нашли, что средняя степень вершины равна 53.85, то есть в среднем каждый сотрудник в сумме получил и отправил около 54 писем в июле 2001 года. Однако в нашем случае усредненное значение нельзя назвать крайне полезным показателем, так как если посмотреть на все значения degree, то мы заметим, что большое количество сотрудников имеют значительно более низкие значения степени. Для уточнения найдем медианное значение, оно равняется 16, что сильно отличается от среднего, то есть можно предположить, что существует несколько сотрудников, которые получили и отправили очень большое число писем и за счет них среднее так отличается от медианы. 

Максимальное значение degree = 1222 и оно соответствует сотруднику с именем Jeff Dasovich. Можно предположить, что это менеджеры среднего уровня (тк их обычно ставят в копию всех писем, касающихся ключевых вопросов + они ведут текущие проекты, то есть часто переписываются с коллегами по поводу операционных деталей) или HR-менеджер (тк он часто пишет другим сотрудникам, причем всем, тк это могут быть вопросы кадровой политики, обучения персонала итд + коммуницирует с менеджерами по поводу найма новых работников)

Минимальное значение degree = 1 и его имеют три сотрудника : Cooper Richey, Kevin Ruscitti, Robert Badeer. В целом можно предположить, что наименьшее количество электронных писем могут получать топ-менеджеры и высшее руководство компании, так как их работа может быть ориентирована на стратегическое планирование и высокоуровневое принятие решений, а не на оперативные детали и ежедневные операции, однако одно письмо все-таки слишком мало для руководящего состава компании. Возможно эти сотрудники были в отпуске в июле, поэтому получили+отправили всего одно письмо, или они работают в отделе, который в целом редко коммуницирует с остальными сотрудниками посредством email (очень узкоспециализированный отдел/лаборатория, где все взаимодействуют в основном лично, а не посредством электронной почты)

**Битвинность: **

Далее мы рассмотрим центральность по посредничеству или битвинность. Формально: Центральность по посредничеству характеризует долю кратчайших путей проходящих через данную вершину.   
В нашем случае битвинность отражает меру того, насколько определенная вершина (сотрудник) лежит на кратчайших путях между другими сотрудниками в сети. Иными словами, это мера того, насколько сотрудник является "посредником" или "мостом" на пути связи между другими сотрудниками компании.  
Вычисление центральности по посредничеству в сети с перепиской сотрудников компании может помочь выявить сотрудников, которые играют важную роль в передаче информации или контроле потока коммуникации в организации. Сотрудники с высокой центральностью по посредничеству могут быть ключевыми связующими элементами между различными отделами, группами или индивидуальными сотрудниками, что может быть полезно при анализе эффективности коммуникационных процессов в организации.  

```{r message = F}
betweenness(net)

mean(betweenness(net))

median(betweenness(net))

max(betweenness(net))
V(net)[betweenness(net) == max(betweenness(net))]$Name


min(betweenness(net))
V(net)[betweenness(net) == min(betweenness(net))]$Name

```
Как и в случае с degree для начала посмотрим на значения битвинности у всех вершин сети, чтобы иметь общую картину: на первый взгляд очень неоднородное распределение значений, тк видим много нулей и много очень больших значений.

Поэтому снова сравним среднее и медиану:
- среднее значение битвинности составляет 151.83. Средняя центральность по посредничеству показывает среднюю 'важность' сотрудников в потоке email
- медианное значение - 0.057, что сильно больше среднего. Это говорит о том, что у нас большое количество маленьких значений битвинности, возможно даже нулевых (посмотрим на это далее), которые и так 'искажают' среднее (делают его менее информативным, тк не соответствуют показателю усредненного сотрудника)

Теперь подробнее посмотрим на максимальное и минимальное значения и сравним их с получившимися ранее степенями:
- максимальная битвинность нашей сети 2437.965 и ее снова имеет Jeff Dasovich. Большая центральность по посредничеству может указывать на то, что определенные сотрудники обладают высоким уровнем влияния на распространение информации в компании. Сотрудники с высоким значением битвинность могут быть ключевыми связующими звеньями, которые помогают сотрудникам в различных группах или отделах находить общий язык, обмениваться идеями, решать проблемы и сотрудничать в рамках организации. Эти работники могут быть ценными кадрами для организации, так как они способствуют эффективному функционированию сети коммуникации и взаимодействия между сотрудниками.
- минимальная битвинность равна 0 и ее имеет сразу 57 сотрудников (среди списка имен однако видим 4 NA, предположим, что это удаленные имена, например уволившихся сотрудников или тех, кто отказался передавать свои данные для этого датасета)

```{r message = F}
V(net)$betweenness <- betweenness(net)
selected_vertices <- V(net)[V(net)$betweenness > 50]
subnet = induced_subgraph(net, selected_vertices)

plot(subnet, 
     vertex.size = betweenness(subnet)/10, 
     vertex.label.cex = degree(subnet)/1000,
     edge.arrow.size=0.5, edge.arrow.width=0.5)
```
  
Сделаем график, чтобы понимать, как вообще выглядят связи между сотрудниками с битвинностью больше 50 (значение подобрано для лучшей визуализации). Это достаточно высокое значение в рамках нашего датасета и на визуализации мы видим, что существует определенное количество сотрудников с большой битвинностью в центре, и от них/к ним расходится/сходится большое количество писем, также заметна коммуникация по одельным группам, то есть предполагаем, что сотрудники много коммуницируют по отделам. 

### Выявление сообществ

**Walktrap**
Будем использовать метод Walktrap для выделения сообществ в нашей сети, так как данный метод умеет работать с направленными сетями (если сделаем граф ненаправленным, то также получим достаточно точные коммюнити, однако при сохранении направленности результат будет более точным)

```{r message = F}
set.seed(1234)
wtcommune <- walktrap.community(net)
membership(wtcommune) ## assigning nodes to communities
modularity(wtcommune)
plot(wtcommune, net)
```
  
Мы видим, что в результате работы метода мы получили 11 сообществ, на получившемся графике мы видим, что в середине есть скопление большого количества сотрудников, которые судя по всему принадлежат нескольким разным группам и тесно коммуницируют друг с другом. В случае нашей сети логично предположить, что выделенные сообщества - это отделы компании или группы людей, задействованные в совместных проектах, а в середине мы возможно видим группы менеджеров, сотрудников, обеспечивающих взаимодействие между всеми сотрудниками, менеджеров  

### Исследовательские вопросы

**Вопрос 1:**
Правда ли, что сотрудники с большим количеством входящих писем имеют схожие должности среднего уровня?

*Расчеты:*
Найдем значения degree c mode = 'in', те количество вхоодящих писем, оттсоортируем их, чтобы лучше понимать, какие значения нам стоит рассматривать.  
```{r message = F}
sort(degree(net, mode = 'in'))
```
Видим, что у нас много относительно низких значений, причем они все идут с небольшими разрывами друг от друга, поэтому найдем первый +- большой скачок и будем рассматривать всех сотрудников со степенью вершины больше этого значения. Чтобы не делать выборку сильно маленькой выберем degree = 45 (скачок с 36 до 45 относительно большой, значения в конце в целом не очень однородны + есть выброс 540, тк это оочень большое значение и оно сильно идет в разрез с выборкой). Далее поссмотрим на должности сотрудников с такими значениями in_degree:

```{r message = F}
V(net)[degree(net, mode = 'in') >= 45]$Note

V(net)[degree(net, mode = 'in') == max(degree(net, mode = 'in'))]$Note
V(net)[degree(net, mode = 'in') == max(degree(net, mode = 'in'))]$Name

degree(net, mode = 'in')[V(net)$Name == 'Jeff Dasovich']
V(net)[Name == 'Jeff Dasovich']$Note
```
Видим, что среди получившихся 15 человек мы имеем:
- 4 вице-президентов
- 2 генеральных директоров
- президента компании и президента (руководителя) онлайн ветки
- управляющего директора
- 2 трейдеров
- 3 рядовых сотрудников
+ у одного человека должность не указана

**Вывод и ответ:**
Нет, нельзя утверждать, что больше всего входящих писем получают сотрудники и управляющие среднего звена, так как по нашим расчетам видно, что большинство людей с наибольшим количеством входящих писем - это высшее руководство компании. Также еще одним подтверждением того, что самое большое количество входящих писем имеет старший менеджмент и руководители, является тот факт, что максимальный показатель in_degree - у вице-президента компании. 
Также мы дополнительно проверили значение in_degree у Jeff Dasovich (ранее уже находили, что у него макс значение битвинности и макс степень вершины), оно оказалось равным 239, те он также находится в нашей выборке, однако имеет должность рядового сотрудника. 

**Вопрос 2:**
Верно ли утверждение, что сотрудники из достаточно обособленных сообществ работают в одном отделе?

*Расчеты:*
Ранее мы уже визуализировали сообщества, полученные методом Walktrap, на визуализации мы вилим три более-менее четких и обособленных собщества, которые можно взять для анализа в данном вопросе : желтое, красное и синее (найдем их далее по номерам, которые видимм на графике)
```{r message = F}
#красное сообщество
red_n = membership(wtcommune)[99]
red_id = groups(wtcommune)[red_n][[1]]
red_node = V(net)$Note[red_id]
red_node
```

```{r message = F}
#синее сообщество
blue_n = membership(wtcommune)[95]
blue_id = groups(wtcommune)[blue_n][[1]]
blue_node =V(net)$Note[blue_id]
blue_node
```

```{r message = F}
#желтое сообщество
yellow_n = membership(wtcommune)[68]
yellow_id = groups(wtcommune)[yellow_n][[1]]
yellow_node = V(net)$Note[yellow_id]
yellow_node

```
**Вывод и ответ:**
Да, можно делать вывод, что в сообществах находятся преимущественно сотрудники из одного отдела, так как в получившихся коммьюнити мы видим либо общие департаменты, либо похожие должности. Если по должностям рядовых сотрудников нельзя понять специфику отдела, то у руководящих должностей обычно указана специализация в компании, что и дает нам возможность понять, что люди в одном сообществе имеют схожие профессиональные специализации. 
Рассмотрим анализируемые выше сообщества подробнее:
- сотрудники красного сообщества занимаются трейдингом, так как в их сообществе сразу три трейдера, а также вице-президент и менеджер, у которых в должности трейдинг фигурирует
- синее собщество вероятно занимается анализом денежных потоков компании, тк сразу две должности, связанные с cash analysis
- желтое сообщество каким-то образом связано с государственным регулированием (регулятором), там менеджер + вице-президент в этой сфере, а также вице-президент, у которого указано казначейство в должности


## Место сотрудника в сети

```{r}
hw_net_get_vertex(net)
```
**Степень вершины: **
```{r message = F}
sort(degree(net))
degree(net)[V(net)$Name == "Ryan Slinger"]
degree(net, mode = 'in')[V(net)$Name == "Ryan Slinger"]
degree(net, mode = 'out')[V(net)$Name == "Ryan Slinger"]

V(net)$Note[V(net)$Name == "Ryan Slinger"]
```
Мы видим, что у сотрудника достаточно высокий показатель степени (выше среднего и медианы, в отсортированном списке степеней стоит близко к концу), при этом большинство писем за этот месяц у него были входящими: 74 всего, из них входящих 62, исходящих - 12. То есть исходя из первого исследовательского вопроса, который был анализирован, вероятно, Ryan Slinger занимает высокую должность в компании. Но после проверки мы выясняем, что предположение было неверно, а Ryan Slinger на самом деле является трейдером. 

**Битвинность: **
```{r message = F}
betweenness(net)[V(net)$Name == "Ryan Slinger"]
```
У нашего сотрудника достаточно низкое значение битвинности, это значит, что что данный сотрудник имеет мало связей или взаимодействий с другими сотрудниками, и его позиция на пути сообщений между другими сотрудниками невысока. То есть Ryan вероятнее всего получает большое количество писем, будучи в копии, однако редко является активным и важным участником переписок, но это вовсе не указывает на низкую производительность или важность сотрудника в организации, так как роль сотрудника в организации может быть разнообразной и не всегда связана с его позицией в сети коммуникаций. Тк мы уже выяснили, что Ryan Slinger занимает позицию трейдера, то мы можем предположить, что большую часть коммуникаций по текущим сделкам он осуществляет с коллегами вживую, ведь нередко трейдеры действуют очень быстро, а совершая сделки на бирже счет идет на минуты или даже секунды, так что возможно электронную почту он использует лишь для обсуждения общих рабочих моментов с руководством, получения информации от других сотрудников


**Walktrap**
```{r message = F}
id_ryan = V(net)[V(net)$Name == "Ryan Slinger"]
#его сообщество
ryan_community = membership(wtcommune)[id_ryan]
ryan_colleagues = groups(wtcommune)[ryan_community][[1]]
ryan_colleagues_node = V(net)$Note[ryan_colleagues]
ryan_colleagues_node

```
Мы видим, что Ryan является членом сообщества, которое мы рассматривали ранее (синее). Мы предполагаем, что этот отдел связан с анализом денежных потоков и финансового положения компании. Тогда сотрудники отдела занимаются анализом и управлением денежными потоками, связанными с операциями организации, включая поступления и выплаты денежных средств, учет и прогнозирование денежных потоков, управление ликвидностью и рисками. Трейдер в отделе Cash Analysis обычно отвечает за выполнение торговых операций на рынке денежных средств, с целью управления корпоративными денежными потоками: выполнение торговых операций на рынке, мониторинг и анализ рыночных условий, включая процентные ставки, валютные курсы, рыночные тренды и другие факторы, влияющие на денежные потоки и риски организации, разработка и реализация торговых стратегий, анализ портфеля денежных инструментов, оценка рисков и производительности, а также предоставление регулярных отчетов и аналитики руководству организации  

## Общие выводы
В результате анализа сети сотрудников нам удалось помять структуру взаимоотношений между сотрудниками в компании, ответить на два исследовательских вопроса, в рамках которых была более подробно изучены центральность и сообщества, а также посмотреть на место конкретного сотрудника в сети и компании.  

**Структура сети:** Анализ сети переписок помог определить структуру коммуникаций между сотрудниками компании. Например, мы смогли определить центральных сотрудников, которые имеют большое количество связей с другими сотрудниками, и тех, кто находится на периферии сети и имеет меньше связей. Мы выяснили, что большей центральностью, то есть большим количеством связей по сравнению с остальными сотрудниками обладают в основном топ-менеджеры и высшее руководство. Однако интересным также является наблюдение, что Jeff Dasovich на должности GR (связи с регуляторами/государством) обладает самой большой степенью и битвинностью. В целом, у большинства сотрудников достаточно низкие показатели центральности, откуда мы делаем вывод, что наверняка они чаще общаются друг с другом непосредственно в офисе, а переписки используют для официальных документов, важного массового информирования (это также объясняет, почему так много писем у высшего руководства: они стоят в копии всех важных писем)
Эта информация может помочь в определении ключевых игроков в организации, которые могут быть важными в процессе принятия решений или разработки стратегии.

**Группы и сообщества:** Анализ сети переписок также помог выявить группы и сообщества сотрудников, которые тесно взаимодействуют друг с другом. В одном из исследовательских вопросов также получилось определить группы сотрудников, работающих на одном проекте, отделе или в определенной локации. В рамках компании такой анализ может помочь в выявлении потенциальных групповых динамик, коммуникационных шаблонов и сильных/слабых связей между группами.

**В итоге,** можно сказать, что анализ подобной сети переписок может быть крайне полезным для стратегического развития компании, так как позволяет наглядно воспроизвести структуру взаимодействия сотрудников путем email за выбранный период времени. Это может помочь наладить более эффективную коммуникацию между сотрудниками, более быстрый обмен информацией, если понимать на каких именно звеньях отсутствует коммуникация, так например, мы увидели, что есть большое число сотрудников с нулевой битвинностью, это достаточно интересный аспект, который имеет потенциал для изучения, однако требует больше информации о структуре организации в компании (нужно понимать, мб этим сотрудникам действительно не свойственна высокая центральность по посредничеству в силу специфических должностей)  Также мы видим, что существуют сферы, которые естественным путем достаточно хорошо развились, например, взаимодействие с топ-менеджментом, а также переписки в рамках отдела/команды проекта. 







